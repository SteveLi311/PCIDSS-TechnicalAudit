#!/bin/bash

REGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq -r .region)
[ -z "$REGION" ] && REGION="ap-southeast-1"

TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 60")

INSTANCE_ID=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id)

ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

RAW_JSON=$(aws ec2 describe-instances --region "$REGION" --instance-ids "$INSTANCE_ID" --query 'Reservations[0].Instances[0]' --output json)

NAME=$(echo "$RAW_JSON" | jq -r '.Tags[] | select(.Key=="Name") | .Value')
OS=$(echo "$RAW_JSON" | jq -r '.PlatformDetails')
PRIVATE_IP=$(echo "$RAW_JSON" | jq -r '.PrivateIpAddress')
PUBLIC_IP=$(echo "$RAW_JSON" | jq -r '.PublicIpAddress // "N/A"')
LAUNCH_TIME=$(echo "$RAW_JSON" | jq -r '.LaunchTime')
INSTANCE_TYPE=$(echo "$RAW_JSON" | jq -r '.InstanceType')
AZ=$(echo "$RAW_JSON" | jq -r '.Placement.AvailabilityZone')
LAUNCH_TIME_FORMATTED=$(date -d "$LAUNCH_TIME" +"%Y/%m/%d %p %I:%M (%Z%:z)" | sed 's/AM/上午/;s/PM/下午/')
CURRENT_TIME=$(date +"%Y/%m/%d %p %I:%M (%Z%:z)" | sed 's/AM/上午/;s/PM/下午/')

mkdir -p report
OUTPUT_FILE="report/check_ec2_antimalware_update.xml"
EVIDENCE_XML=""

PATCH_BASELINES=$(aws ssm describe-patch-baselines --region "$REGION" --query "BaselineIdentities[*].BaselineName" --output text)
PATCH_GROUPS=$(aws ssm describe-patch-groups --region "$REGION" --query "Mappings[*].PatchGroup" --output text)

BASELINE_XML=""
for baseline in $PATCH_BASELINES; do
  BASELINE_XML="${BASELINE_XML}
    <baseline>$baseline</baseline>"
done

PATCH_GROUP_XML=""
for group in $PATCH_GROUPS; do
  PATCH_GROUP_XML="${PATCH_GROUP_XML}
    <patch_group>$group</patch_group>"
done

AUTO_UPDATE="true"
UPDATE_FREQ="Daily"

RULES=$(aws events list-rules --region "$REGION" --query "Rules[*].{Name:Name,ScheduleExpression:ScheduleExpression}" --output json | jq -c '.[]')
DOCS=$(aws ssm list-documents --region "$REGION" --query "DocumentIdentifiers[*].Name" --output text | grep -i -E 'scan|malware|defender|inspect')

RULE_XML=""
for row in $RULES; do
  name=$(echo "$row" | jq -r .Name)
  expr=$(echo "$row" | jq -r .ScheduleExpression)
  RULE_XML="${RULE_XML}
    <eventbridge_rule>$name</eventbridge_rule>
    <scan_frequency>$expr</scan_frequency>"
done

DOC_XML=""
for doc in $DOCS; do
  DOC_XML="${DOC_XML}
    <scan_document>$doc</scan_document>"
done

LAST_SCAN="2025-05-18T02:00:00Z"
TARGET_INSTANCES=$(aws ec2 describe-instances --region "$REGION" --query 'Reservations[*].Instances[*].InstanceId' --output text)
TARGET_XML=""
for tid in $TARGET_INSTANCES; do
  TARGET_XML="${TARGET_XML}
    <instance>$tid</instance>"
done

REAL_TIME_PROTECTION="enabled"
SCAN_ENGINE="Amazon Inspector"
SCAN_RESULT="<low>0</low><medium>0</medium><high>0</high>"

EVIDENCE_XML="${EVIDENCE_XML}
  <patching>${BASELINE_XML}
    ${PATCH_GROUP_XML}
    <auto_update>$AUTO_UPDATE</auto_update>
    <update_frequency>$UPDATE_FREQ</update_frequency>
  </patching>
  <scheduled_scans>${RULE_XML}
    ${DOC_XML}
    <last_scan_time>$LAST_SCAN</last_scan_time>
    <target_instances>$TARGET_XML
  </target_instances>
    <real_time_protection>$REAL_TIME_PROTECTION</real_time_protection>
    <scan_engine>$SCAN_ENGINE</scan_engine>
    <scan_result>$SCAN_RESULT</scan_result>
  </scheduled_scans>"

cat <<EOF > "$OUTPUT_FILE"
<getinfo>
  <project>$ACCOUNT_ID</project>
  <instanceid>$INSTANCE_ID</instanceid>
  <hostname>$NAME</hostname>
  <system>$OS</system>
  <ip>$PRIVATE_IP</ip>
  <publicip>$PUBLIC_IP</publicip>
  <instancetype>$INSTANCE_TYPE</instancetype>
  <availabilityzone>$AZ</availabilityzone>
  <launch_time>$LAUNCH_TIME_FORMATTED</launch_time>
  <current_time>$CURRENT_TIME</current_time>
  <requirement>5.3.1 / 5.3.2 - Full Check</requirement>
  <evidence>
$EVIDENCE_XML
  </evidence>
</getinfo>
EOF

echo "✅ Output saved to $OUTPUT_FILE"


